<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Vehicle Fleet Dashboard</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	<script src="https://cdn.tailwindcss.com"></script>
	<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Inter', sans-serif;
		}

		.glass-effect {
			backdrop-filter: blur(10px);
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		.stat-card {
			background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
			border: 1px solid rgba(99, 102, 241, 0.2);
			transition: all 0.3s ease;
		}

		.stat-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
		}

		.vehicle-marker {
			background: linear-gradient(45deg, #3b82f6, #8b5cf6);
			border: 2px solid white;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.pulse-animation {
			animation: pulse 2s infinite;
		}

		@keyframes pulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}

		.leaflet-popup-content-wrapper {
			background: rgba(0, 0, 0, 0.8);
			color: white;
			border-radius: 12px;
			backdrop-filter: blur(10px);
		}

		.leaflet-popup-tip {
			background: rgba(0, 0, 0, 0.8);
		}

		#map {
			border-radius: 16px;
			overflow: hidden;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
		}

		.status-indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			display: inline-block;
			margin-right: 8px;
		}

		.status-online {
			background: #10b981;
			box-shadow: 0 0 8px #10b981;
		}

		.status-offline {
			background: #ef4444;
		}
	</style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
	<div x-data="vehicleApp()" class="container mx-auto p-4">
		<!-- Header -->
		<div class="mb-6">
			<div class="flex items-center justify-between mb-4">
				<div class="flex items-center space-x-3">
					<div
						class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
						<span class="text-2xl">üöó</span>
					</div>
					<div>
						<h1
							class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
							Vehicle Fleet Dashboard
						</h1>
						<p class="text-slate-400">Real-time vehicle simulation monitoring</p>
					</div>
				</div>
				<div class="flex items-center space-x-2">
					<div class="status-indicator" :class="isOnline ? 'status-online' : 'status-offline'"></div>
					<span class="text-sm" x-text="isOnline ? 'Connected' : 'Disconnected'"></span>
				</div>
			</div>

			<!-- Stats Cards -->
			<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
				<div class="stat-card rounded-xl p-4">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-slate-400 text-sm">Active Vehicles</p>
							<p class="text-2xl font-bold" x-text="stats.activeVehicles"></p>
						</div>
						<div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
							<span class="text-green-400">üöô</span>
						</div>
					</div>
				</div>
				<div></div>
				<div></div>

				<!-- <div class="stat-card rounded-xl p-4"> -->
				<!-- 	<div class="flex items-center justify-between"> -->
				<!-- 		<div> -->
				<!-- 			<p class="text-slate-400 text-sm">Avg Speed</p> -->
				<!-- 			<p class="text-2xl font-bold" x-text="stats.avgSpeed + ' km/h'"></p> -->
				<!-- 		</div> -->
				<!-- 		<div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center"> -->
				<!-- 			<span class="text-blue-400">‚ö°</span> -->
				<!-- 		</div> -->
				<!-- 	</div> -->
				<!-- </div> -->
				<!---->
				<!-- <div class="stat-card rounded-xl p-4"> -->
				<!-- 	<div class="flex items-center justify-between"> -->
				<!-- 		<div> -->
				<!-- 			<p class="text-slate-400 text-sm">Total Distance</p> -->
				<!-- 			<p class="text-2xl font-bold" x-text="stats.totalDistance + ' km'"></p> -->
				<!-- 		</div> -->
				<!-- 		<div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center"> -->
				<!-- 			<span class="text-purple-400">üìç</span> -->
				<!-- 		</div> -->
				<!-- 	</div> -->
				<!-- </div> -->

				<div class="stat-card rounded-xl p-4">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-slate-400 text-sm">Emergency Brakes</p>
							<p class="text-2xl font-bold" x-text="stats.emergencyBrakes"
								:class="stats.emergencyBrakes > 0 ? 'text-red-400' : ''"></p>
						</div>
						<div class="w-10 h-10 rounded-lg flex items-center justify-center"
							:class="stats.emergencyBrakes > 0 ? 'bg-red-500/20' : 'bg-orange-500/20'">
							<span :class="stats.emergencyBrakes > 0 ? 'text-red-400' : 'text-orange-400'"
								x-text="stats.emergencyBrakes > 0 ? '‚ö†Ô∏è' : 'üõ°Ô∏è'"></span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
			<!-- Map -->
			<div class="lg:col-span-3">
				<div class="glass-effect rounded-2xl p-1">
					<div id="map" class="h-[70vh]"></div>
				</div>
			</div>

			<!-- Vehicle List -->
			<div class="lg:col-span-1">
				<div class="glass-effect rounded-2xl p-6 h-[70vh] overflow-hidden">
					<div class="flex items-center justify-between mb-4">
						<h3 class="text-lg font-semibold">Vehicle List</h3>
						<span class="text-sm text-slate-400" x-text="'Last updated: ' + lastUpdate"></span>
					</div>

					<div class="space-y-3 overflow-y-auto h-full pb-16">
						<template x-for="vehicle in vehicles" :key="vehicle.vehicle_id">
							<div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 hover:border-slate-600/50 transition-all cursor-pointer"
								@click="focusVehicle(vehicle)"
								:class="vehicle.emergency_brake ? 'ring-2 ring-red-500/50 bg-red-900/20' : ''">
								<div class="flex items-center justify-between mb-2">
									<span class="font-medium text-sm" x-text="vehicle.vehicle_id"></span>
									<div class="flex items-center space-x-2">
										<span x-show="vehicle.emergency_brake"
											class="text-xs px-2 py-1 bg-red-500/20 text-red-400 rounded animate-pulse">‚ö†Ô∏è
											BRAKE</span>
										<span
											class="text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded">Active</span>
									</div>
								</div>
								<div class="text-xs text-slate-400 space-y-1">
									<div class="grid grid-cols-2 gap-2">
										<div>üìç <span x-text="vehicle.gps.latitude.toFixed(4)"></span></div>
										<div><span x-text="vehicle.gps.longitude.toFixed(4)"></span></div>
									</div>
									<div>‚ö° <span x-text="(Math.random() * 60 + 20).toFixed(1) + ' km/h'"></span></div>

									<!-- Sensor Data -->
									<div class="pt-2 border-t border-slate-700/50">
										<div class="text-xs text-slate-500 mb-1">Sensors</div>
										<div class="grid grid-cols-2 gap-1">
											<div>üîç Front: <span
													x-text="vehicle.sensors?.front_distance?.toFixed(1) || '0.0'"
													class="text-blue-400"></span>m</div>
											<div>üîç Rear: <span
													x-text="vehicle.sensors?.rear_distance?.toFixed(1) || '0.0'"
													class="text-purple-400"></span>m</div>
										</div>
										<div class="grid grid-cols-2 gap-1 mt-1">
											<div class="text-xs">
												Œî <span
													x-text="vehicle.sensors?.front_distance_change?.toFixed(2) || '0.0'"
													:class="(vehicle.sensors?.front_distance_change || 0) < 0 ? 'text-red-400' : 'text-green-400'"></span>
											</div>
											<div class="text-xs">
												Œî <span
													x-text="vehicle.sensors?.rear_distance_change?.toFixed(2) || '0.0'"
													:class="(vehicle.sensors?.rear_distance_change || 0) < 0 ? 'text-red-400' : 'text-green-400'"></span>
											</div>
										</div>
									</div>

									<!-- Position Delta -->
									<div class="pt-2 border-t border-slate-700/50">
										<div class="text-xs text-slate-500 mb-1">GPS Position Œî</div>
										<div class="grid grid-cols-2 gap-1">
											<div>Lat: <span x-text="vehicle.position_delta.latitude.toFixed(5)"></span>
											</div>
											<div>Lng: <span x-text="vehicle.position_delta.longitude.toFixed(5)"></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</template>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<script>
		function vehicleApp() {
			return {
				map: null,
				markers: {},
				vehicles: [],
				isOnline: true,
				lastUpdate: '',
				stats: {
					activeVehicles: 0,
					avgSpeed: 0,
					totalDistance: 0,
					updatesPerSec: 2,
					emergencyBrakes: 0
				},

				async init() {
					await this.fetchLocations();
					setInterval(() => this.fetchLocations(), 500);
				},

				async fetchLocations() {
					try {
						// Fetch all vehicle data in parallel
						// const [locationsResponse, sensorsResponse, emergenciesResponse] = await Promise.all([
						//     fetch("/lt/api/vehicles/latest-locations"),
						//     fetch("/cd/api/vehicles"),
						//     fetch("/dm/api/vehicles")
						// ]);
						//
						// const [locationsData, sensorsData, emergenciesData] = await Promise.all([
						//     locationsResponse.json(),
						//     sensorsResponse.json(),
						//     emergenciesData.json()
						// ]);

						const locationsResponse = await fetch("/api/vehicles/latest-locations");
						const locationsDataTemp = await locationsResponse.json();

						const locationsData = [
							...locationsDataTemp,
						]

						console.log("Locations Data after merge:", locationsData);

						const sensorsData = [
							{vehicle_id: "vehicle-1", front_distance: 5.2, rear_distance: 3.8, front_distance_change: -0.1, rear_distance_change: 0.2},
							{vehicle_id: "vehicle-2", front_distance: 4.5, rear_distance: 3.0, front_distance_change: 0.0, rear_distance_change: -0.3},
						];

						// Simulated emergency data
						const emergenciesData = [{
							vehicle_id: "vehicle-1",
							emergency_brake: true
						}, {
							vehicle_id: "vehicle-2",
							emergency_brake: false
						}];

						// Merge all data by vehicle_id
						this.vehicles = locationsData.map(vehicle => {
							const sensorData = sensorsData.find(s => s.vehicle_id === vehicle.vehicle_id) || {};
							const emergencyData = emergenciesData.find(e => e.vehicle_id === vehicle.vehicle_id) || {};

							return {
								...vehicle,
								sensors: {
									front_distance: sensorData.front_distance || 0,
									rear_distance: sensorData.rear_distance || 0,
									front_distance_change: sensorData.front_distance_change || 0,
									rear_distance_change: sensorData.rear_distance_change || 0
								},
								emergency_brake: emergencyData.emergency_brake || false
							};
						});

						this.isOnline = true;
						this.lastUpdate = new Date().toLocaleTimeString();
						this.updateStats();

						if (!this.map && this.vehicles.length > 0) {
							this.initializeMap(this.vehicles[0]);
						}

						this.updateMarkers(this.vehicles);

					} catch (err) {
						console.error("Error loading vehicle data:", err);
						this.isOnline = false;
					}
				},

				initializeMap(firstVehicle) {
					this.map = L.map("map", {
						zoomControl: false,
						attributionControl: false
					}).setView([firstVehicle.gps.latitude, firstVehicle.gps.longitude], 15);

					// Dark theme tiles
					L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
						attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
					}).addTo(this.map);

					// Custom zoom control
					L.control.zoom({
						position: 'bottomright'
					}).addTo(this.map);
				},

				updateMarkers(data) {
					// Remove markers for vehicles no longer in data
					Object.keys(this.markers).forEach(id => {
						if (!data.find(v => v.vehicle_id === id)) {
							this.map.removeLayer(this.markers[id]);
							delete this.markers[id];
						}
					});

					data.forEach((vehicle) => {
						const {latitude, longitude} = vehicle.gps;
						const id = vehicle.vehicle_id;

						// Create custom icon
						const customIcon = L.divIcon({
							className: 'vehicle-marker',
							html: `<div style="
                                width: 20px; 
                                height: 20px; 
                                border: 2px solid white;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 10px;
                            ">üöó</div>`,
							iconSize: [24, 24],
							iconAnchor: [12, 12]
						});

						if (this.markers[id]) {
							// Smooth animation to new position
							this.markers[id].setLatLng([latitude, longitude]);
						} else {
							// Add new marker
							this.markers[id] = L.marker([latitude, longitude], {
								icon: customIcon
							})
								.addTo(this.map)
								.bindPopup(`
                                <div class="p-4 w-64">
                                    <div class="font-bold text-lg mb-3 flex items-center justify-between">
                                        <span>${id}</span>
                                        ${vehicle.emergency_brake ? '<span class="text-red-400 text-sm animate-pulse">‚ö†Ô∏è EMERGENCY BRAKE</span>' : ''}
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <div class="text-slate-400 text-xs mb-1">Location</div>
                                                <div>üìç ${latitude.toFixed(5)}</div>
                                                <div>üìç ${longitude.toFixed(5)}</div>
                                            </div>
                                            <div>
                                                <div class="text-slate-400 text-xs mb-1">Speed & Direction</div>
                                                <div>‚ö° ${(Math.random() * 60 + 20).toFixed(1)} km/h</div>
                                                <div>üß≠ ${Math.floor(Math.random() * 360)}¬∞</div>
                                            </div>
                                        </div>
                                        <div class="border-t border-slate-600 pt-2">
                                            <div class="text-slate-400 text-xs mb-1">Sensor Distances</div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>üîç Front: <span class="text-blue-400">${(vehicle.sensors?.front_distance || 0).toFixed(1)}m</span></div>
                                                <div>üîç Rear: <span class="text-purple-400">${(vehicle.sensors?.rear_distance || 0).toFixed(1)}m</span></div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2 mt-1 text-xs">
                                                <div>Œî Front: <span class="${(vehicle.sensors?.front_distance_change || 0) < 0 ? 'text-red-400' : 'text-green-400'}">${(vehicle.sensors?.front_distance_change || 0).toFixed(2)}</span></div>
                                                <div>Œî Rear: <span class="${(vehicle.sensors?.rear_distance_change || 0) < 0 ? 'text-red-400' : 'text-green-400'}">${(vehicle.sensors?.rear_distance_change || 0).toFixed(2)}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
								`, {
									maxWidth: 500,
								});
						}
					});
				},

				updateStats() {
					this.stats.activeVehicles = this.vehicles.length;
					this.stats.avgSpeed - 1 // (Math.random() * 30 + 35).toFixed(1);
					this.stats.totalDistance - 1 // (Math.random() * 1000 + 5000).toFixed(0);
					this.stats.emergencyBrakes = this.vehicles.filter(v => v.emergency_brake).length;
				},

				focusVehicle(vehicle) {
					if (this.map && this.markers[vehicle.vehicle_id]) {
						this.map.setView([vehicle.gps.latitude, vehicle.gps.longitude], 18);
						this.markers[vehicle.vehicle_id].openPopup();
					}
				}
			}
		}
	</script>
</body>

</html>
